<!DOCTYPE html>
<html lang="en">

<head>
   <meta charset="UTF-8" />
   <meta name="viewport" content="width=device-width, initial-scale=1.0" />
   <link rel="preconnect" href="https://fonts.googleapis.com">
   <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
   <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
      rel="stylesheet">
   <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"
      referrerpolicy="no-referrer"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.min.js" crossorigin="anonymous"
      referrerpolicy="no-referrer"></script>
   <script src="https://cdn.jsdelivr.net/npm/obs-websocket-js"></script>
   <script src="connection.js"></script>
   <script src="app.js"></script>
   <title>Dynamic Ranking Grid</title>
   <style>
      :root {
         --grid-gap: 0px;
         --row-height: 36px;
         --last-row-height: 20px;
         --marquee-speed: 6s;
         --text-gap: 10px;
         --transition-duration: 0.5s;
      }

      body {
         font-family: "Roboto", Arial, sans-serif;
         margin: 20px;
         white-space: nowrap;
         overflow: hidden;
         color: white;
      }

      #container {
         position: relative;
         width: 223px;
         /* height: 735px; */
         /* height: 800px; */
         overflow: hidden;
         /* border: 1px solid #ccc; */
         border-radius: 10px;
         background-color: rgba(0, 0, 0, 0.8);

         padding: 16px 0;
      }

      .title {
         font-size: 1em;
         margin-bottom: 12px;
         margin-left: 18px;
         color: #b3b3b3;
         font-weight: 200;
      }

      #ranking-grid {
         position: relative;
         /* display: grid;
         grid-template-columns: 37px 93px 70px;
         grid-auto-rows: var(--row-height);
         gap: var(--grid-gap);
         width: 305px; */

      }

      .row {
         display: grid;
         grid-template-columns: 37px 93px 85px;
         position: absolute;
         left: 0;
         right: 0;
         transition: transform var(--transition-duration);
         height: var(--row-height);
         overflow: hidden;
      }

      .row.last {
         height: var(--last-row-height);
      }

      .cell {
         display: flex;
         align-items: center;
         justify-content: center;
         /* border: 1px solid #ccc; */
         padding: 0;
         overflow: hidden;
         position: relative;
         height: 22px;
      }

      .cell.name {
         justify-content: flex-start;
         font-weight: 300;
      }

      .marquee {
         display: inline-flex;
         animation: scroll var(--marquee-speed) linear infinite;
      }

      .marquee span {
         padding-right: var(--text-gap);
      }

      @keyframes scroll {
         0% {
            transform: translateX(0%);
         }

         100% {
            transform: translateX(-50%);
         }
      }

      .rank-number {
         font-size: 1em;
         font-weight: 400;
         /* font-weight: bold; */
         /* line-height: 1; */
         z-index: 2;
      }

      .crown {
         position: absolute;
         bottom: 3px;
         width: 24px;
         height: 24px;
         visibility: hidden;
         overflow: hidden;
      }

      .crown img {
         width: 72px;
         /* sprite width = 3 crowns * 24px each */
         height: 54px;
         object-fit: fill;
         object-position: 0 0;
      }

      /* top-row: gold at 0px, silver at -24px, bronze at -48px */
      .crown.gold img {
         visibility: visible;
         object-position: 0 0;
      }

      .crown.silver img {
         visibility: visible;
         object-position: -24px 0;
      }

      .crown.bronze img {
         visibility: visible;
         object-position: -48px 0;
      }

      .score {
         font-size: 1.1em;
         font-weight: bold;
         justify-content: left;
         padding-left: 5px;
      }
   </style>
</head>

<body>
   <div id="container">
      <div class="title" for="">Ranking list</div>
      <div id="rankingGrid"></div>
   </div>

   <script>
      //init render the leaderboard
      $('document').ready(function () {
         // Initialize the connection
      });
      connection.reRender("#rankingGrid")
      connection.on("reRender", rows => {
         let data = [];
         console.log("reRender", rows);
         data = rows[0].receiversDetails.slice(1).map((item, index) => ({
            name: item.nickname,
            score: 0,
         }));
         rows.slice(1).forEach(row => {
            row.receiversDetails.slice(1).forEach((item, index) => {
               const player = data.find(p => p.name === item.nickname);
               if (player) {
                  if (!round || row.round === round)
                     player.score += item.receiveDiamond;
               } else {
                  data.push({
                     name: item.nickname,
                     score: item.score
                  });
               }
            });
         });
         //sort data by score
         data.sort((a, b) => b.score - a.score);
         console.log("data", data);
      })
      // Sprite sheet with 3 crowns side-by-side: gold | silver | bronze
      const crownSrc = '/images/crowns.png'; // Adjust the path as needed

      //array of 20 contenstants
      let player = ["NVX BIN", "NVX L", "NVX DLEE", "NVX SHIN",
         "RDNV CICI", "RDNV LILY", "RDNV CHANEE", "RDNV HANNIE", "RDNV ZELZI", "RDNV WINA",
         "TYHT ĐẠO TIÊN", "TYHT HỒ YÊU", "TYHT BẠCH XÀ", "TYHT CHUỘT TINH",
         "KZN YOUNG D", "KZN CARO", "KZN PUDY", "KZN HISSHIN", "KZN MIKE", "KZN KRYS"
      ];
      //generate data with random scores
      let data = player.map((name, index) => ({
         name: name,
         score: Math.floor(Math.random() * 1000000)
      }));

      //create a function to render the grid
      function initGrid(data) {
         const grid = document.getElementById('rankingGrid');
         grid.innerHTML = ''; // Clear existing content


         data.forEach((item, index) => {
            const row = document.createElement('div');
            row.className = 'row';
            row.dataset.name = item.name;

            // Rank number cell
            const rankCell = document.createElement('div');
            rankCell.className = 'cell';
            const num = document.createElement('div');
            num.className = 'rank-number';
            num.textContent = index + 1;
            rankCell.appendChild(num);
            row.appendChild(rankCell);

            // Name cell with marquee
            const nameCell = document.createElement('div');
            nameCell.className = 'cell name';
            const marqueeElement = document.createElement('div');
            marqueeElement.className = 'marquee';
            const span1 = document.createElement('span');
            span1.textContent = item.name;
            const span2 = document.createElement('span');
            span2.textContent = item.name;
            marqueeElement.appendChild(span1);
            marqueeElement.appendChild(span2);
            nameCell.appendChild(marqueeElement);
            row.appendChild(nameCell);

            // Score cell
            const scoreCell = document.createElement('div');
            scoreCell.className = 'cell score';
            scoreCell.textContent = item.score.toLocaleString(); // Format with commas
            row.appendChild(scoreCell);

            // Crown container
            const crown = document.createElement('div');
            crown.className = 'crown';
            if (index < 3) {
               crown.classList.add(['gold', 'silver', 'bronze'][index]);
               const img = document.createElement('img');
               img.src = crownSrc;
               img.alt = 'Crown';
               crown.appendChild(img);
               rankCell.appendChild(crown);
            }

            grid.appendChild(row);
         });
      }

      const grid = document.getElementById('rankingGrid');
      const container = document.getElementById('container');
      // calculate grid height
      const gridHeight = (data.length - 1) * parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--row-height'))
         + parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--last-row-height'))
         + document.querySelector('.title').offsetHeight + parseFloat(getComputedStyle(document.querySelector('.title')).marginBottom) + 1;
      // set container height
      container.style.height = gridHeight + 'px';

      // Initialize rows
      data.forEach(item => {
         const row = document.createElement('div');
         row.className = 'row';
         row.dataset.name = item.name;
         // rank number
         const rankCell = document.createElement('div');
         rankCell.className = 'cell';
         const num = document.createElement('div');
         num.className = 'rank-number';
         rankCell.appendChild(num);
         row.appendChild(rankCell);
         // name cell
         const nameCell = document.createElement('div');
         nameCell.className = 'cell name';
         const marqueeElement = document.createElement('div');
         marqueeElement.className = 'marquee';
         const span1 = document.createElement('span');
         span1.textContent = item.name;
         const span2 = document.createElement('span');
         span2.textContent = item.name;
         marqueeElement.appendChild(span1);
         marqueeElement.appendChild(span2);
         nameCell.appendChild(marqueeElement);
         row.appendChild(nameCell);
         // score cell
         const scoreCell = document.createElement('div');
         scoreCell.className = 'cell score';
         row.appendChild(scoreCell);

         // crown container
         const crown = document.createElement('div');
         crown.className = 'crown';
         const img = document.createElement('img');
         img.src = crownSrc;
         img.alt = 'Crown';
         crown.appendChild(img);
         rankCell.appendChild(crown);

         grid.appendChild(row);
      });

      function renderGrid() {
         //sort data by score
         data.sort((a, b) => b.score - a.score);
         const rows = Array.from(grid.children);

         data.forEach((item, index) => {
            const row = rows.find(r => r.dataset.name == item.name);
            // update content
            row.querySelector('.rank-number').textContent = index + 1;
            row.querySelector('.cell.score').textContent = item.score.toLocaleString(); // Format with commas
            // crown class
            row.classList.toggle('last', index === data.length - 1);
            const crown = row.querySelector('.crown');
            crown.className = 'crown ' + (index < 3 ? ['gold', 'silver', 'bronze'][index] : '');
            // position
            const y = index * parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--row-height'));
            row.style.transform = `translateY(${y}px)`;
         });

      }

      renderGrid();

      function updateScores(newScores) {
         newScores.forEach(ns => {
            const entry = data.find(d => d.name === ns.name);
            if (entry) entry.score += ns.score;
         });
         renderGrid();
      }

      setInterval(() => {
         const randIndex = Math.floor(Math.random() * data.length);
         data[randIndex].score += Math.floor(Math.random() * 100000);
         renderGrid();
      }, 1000);
   </script>

</body>

</html>