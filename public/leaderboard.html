<!DOCTYPE html>
<html lang="en">

<head>
   <meta charset="UTF-8" />
   <meta name="viewport" content="width=device-width, initial-scale=1.0" />
   <link rel="preconnect" href="https://fonts.googleapis.com">
   <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
   <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
      rel="stylesheet">
   <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"
      referrerpolicy="no-referrer"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.min.js" crossorigin="anonymous"
      referrerpolicy="no-referrer"></script>
   <script src="https://cdn.jsdelivr.net/npm/obs-websocket-js"></script>
   <script src="connection.js"></script>
   <script src="app.js"></script>
   <title>Dynamic Ranking Grid</title>
   <style>
      :root {
         --grid-gap: 0px;
         --row-height: 36px;
         --last-row-height: 20px;
         --marquee-speed: 6s;
         --text-gap: 10px;
         --transition-duration: 0.5s;
      }

      body {
         font-family: "Roboto", Arial, sans-serif;
         margin: 20px;
         white-space: nowrap;
         overflow: hidden;
         color: white;
      }

      #container {
         position: relative;
         width: 223px;
         /* height: 735px; */
         /* height: 800px; */
         overflow: hidden;
         /* border: 1px solid #ccc; */
         border-radius: 10px;
         background-color: rgba(0, 0, 0, 0.8);

         padding: 16px 0;
      }

      .title {
         font-size: 1em;
         margin-bottom: 12px;
         margin-left: 18px;
         color: #b3b3b3;
         font-weight: 200;
      }

      #ranking-grid {
         position: relative;
         /* display: grid;
         grid-template-columns: 37px 93px 70px;
         grid-auto-rows: var(--row-height);
         gap: var(--grid-gap);
         width: 305px; */

      }

      .row {
         display: grid;
         grid-template-columns: 37px 93px 85px;
         position: absolute;
         left: 0;
         right: 0;
         transition: transform var(--transition-duration);
         height: var(--row-height);
         overflow: hidden;
      }

      .row.last {
         height: var(--last-row-height);
      }

      .cell {
         display: flex;
         align-items: center;
         justify-content: center;
         /* border: 1px solid #ccc; */
         padding: 0;
         overflow: hidden;
         position: relative;
         height: 22px;
      }

      .cell.name {
         justify-content: flex-start;
         font-weight: 300;
      }

      .marquee {
         display: inline-flex;
         animation: scroll var(--marquee-speed) linear infinite;
      }

      .marquee span {
         padding-right: var(--text-gap);
      }

      @keyframes scroll {
         0% {
            transform: translateX(0%);
         }

         100% {
            transform: translateX(-50%);
         }
      }

      .rank-number {
         font-size: 1em;
         font-weight: 400;
         /* font-weight: bold; */
         /* line-height: 1; */
         z-index: 2;
      }

      .crown {
         position: absolute;
         bottom: 3px;
         width: 24px;
         height: 24px;
         visibility: hidden;
         overflow: hidden;
      }

      .crown img {
         width: 72px;
         /* sprite width = 3 crowns * 24px each */
         height: 54px;
         object-fit: fill;
         object-position: 0 0;
      }

      .danger {
         color: rgb(172, 171, 171)
      }

      /* top-row: gold at 0px, silver at -24px, bronze at -48px */
      .crown.gold img {
         visibility: visible;
         object-position: 0 0;
      }

      .crown.silver img {
         visibility: visible;
         object-position: -24px 0;
      }

      .crown.bronze img {
         visibility: visible;
         object-position: -48px 0;
      }

      .score {
         font-size: 1.1em;
         font-weight: bold;
         justify-content: left;
         padding-left: 5px;
      }
   </style>
</head>

<body>
   <div id="container">
      <div class="title" for="">Ranking list</div>
      <div id="rankingGrid"></div>
   </div>

   <script>

      let data = [];
      let safeRanking = 20;
      connection.reRender("#rankingGrid")

      function formatTime(seconds) {
         const mm = String(Math.floor(seconds / 60)).padStart(2, '0');
         const ss = String(seconds % 60).padStart(2, '0');
         return `${mm}:${ss}`;
      }
      //countdown socket event
      let interval
      connection.on("countdown", duration => {
         const title = document.querySelector('.title');
         title.textContent = `${round ? round.toUpperCase() : 'NOVIX'} ${formatTime(duration)}`

         //clear any existing interval
         if (interval) {
            clearInterval(interval);
         }

         //set interval to update the title every second
         let timer = duration;
         interval = setInterval(() => {
            if (timer > 0) {
               title.textContent = `${round ? round.toUpperCase() : ''} ${formatTime(timer)}`;
            } else {
               clearInterval(interval);
               title.textContent = `${round ? round.toUpperCase() : ''} End!`;
            }
            timer--;
         }, 1000);


      });

      connection.on("reRender", rows => {
         //clear existing interval
         if (interval) {
            clearInterval(interval);
         }
         console.log("reRender", rows);
         data = rows[0].receiversDetails
            .slice(1)
            .filter(item => !hideRowMembers || !hideRowMembers.length || !hideRowMembers.includes(item.nickname))
            .map((item, index) => ({
               name: item.nickname,
               score: 0,
            }));
         console.log("filtered rows", rows);

         rows.slice(1).forEach(row => {
            row.receiversDetails.slice(1).forEach((item, index) => {
               const player = data.find(p => p.name === item.nickname);
               if (!hideRowMembers || !hideRowMembers.length || !hideRowMembers.includes(item.nickname)) {
                  if (player) {
                     if (!round || row.round === round)
                        player.score += item.receiveDiamond;
                  } else {
                     data.push({
                        name: item.nickname,
                        score: item.score
                     });
                  }
               }
            });
         });
         //sort data by score
         data.sort((a, b) => b.score - a.score);
         console.log("data", data);
         initGrid(data);
      })
      // Sprite sheet with 3 crowns side-by-side: gold | silver | bronze
      const crownSrc = '/images/crowns.png'; // Adjust the path as needed


      const grid = document.getElementById('rankingGrid');
      const container = document.getElementById('container');
      //create a function to render the grid
      function initGrid(data) {
         grid.innerHTML = ''; // Clear existing content
         // calculate grid height
         const gridHeight = (data.length - 1) * parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--row-height'))
            + parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--last-row-height'))
            + document.querySelector('.title').offsetHeight + parseFloat(getComputedStyle(document.querySelector('.title')).marginBottom) + 1;
         // set container height
         container.style.height = gridHeight + 'px';
         //set title to the round
         const title = document.querySelector('.title');
         title.textContent = `${round ? round.toUpperCase() : 'NOVIX'}`;
         if(round === 'round1'){
            safeRanking = 20;
         }else if (round === 'round2' || round === 'round3') {
            safeRanking = 8;
         }else if (round === 'round4' || round === 'round5') {
            safeRanking = 3;
         }
         data.forEach((item, index) => {
            const row = document.createElement('div');
            row.className = 'row';
            row.classList.toggle('danger', index >= safeRanking);
            row.dataset.name = item.name;

            // Rank number cell
            const rankCell = document.createElement('div');
            rankCell.className = 'cell';
            const num = document.createElement('div');
            num.className = 'rank-number';
            num.textContent = index + 1;
            rankCell.appendChild(num);
            row.appendChild(rankCell);

            // Name cell with marquee

            const nameCell = document.createElement('div');
            nameCell.className = 'cell name';
            const text = document.createElement('div');
            text.textContent = item.name;
            nameCell.appendChild(text);
            setTimeout(() => {
               if (text.scrollWidth > nameCell.clientWidth) {
                  // text.className = 'marquee';
                  //empty nameCell
                  nameCell.innerHTML = '';
                  //create marquee
                  const marquee = document.createElement('div'); marquee.className = 'marquee';
                  const span1 = document.createElement('span'); span1.textContent = item.name;
                  const span2 = document.createElement('span'); span2.textContent = item.name;
                  marquee.appendChild(span1);
                  marquee.appendChild(span2);
                  nameCell.appendChild(marquee);
               }
            });
            row.appendChild(nameCell);

            // Score cell
            const scoreCell = document.createElement('div');
            scoreCell.className = 'cell score';
            scoreCell.textContent = item.score.toLocaleString(); // Format with commas
            row.appendChild(scoreCell);

            // Crown container
            const crown = document.createElement('div');
            crown.className = 'crown';
            const img = document.createElement('img');
            crown.classList.add(['gold', 'silver', 'bronze'][index]);
            img.src = crownSrc;
            img.alt = 'Crown';
            crown.appendChild(img);
            rankCell.appendChild(crown);

            grid.appendChild(row);
         });
         renderGrid();
      }

      function renderGrid() {
         //sort data by score
         data.sort((a, b) => b.score - a.score);
         const rows = Array.from(grid.children);

         data.forEach((item, index) => {
            const row = rows.find(r => r.dataset.name == item.name);
            // update content
            row.querySelector('.rank-number').textContent = index + 1;
            row.querySelector('.cell.score').textContent = item.score.toLocaleString(); // Format with commas
            // crown class
            row.classList.toggle('last', index === data.length - 1);

            if (index < 3) {
               const crown = row.querySelector('.crown');
               crown.className = 'crown ' + (index < 3 ? ['gold', 'silver', 'bronze'][index] : '');
            }
            // position
            const y = index * parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--row-height'));
            row.style.transform = `translateY(${y}px)`;
         });

      }

      renderGrid();

      
      connection.on("hideRanking", (hideMembers) => {
         console.log("hideRanking", hideMembers);
         hideRowMembers = hideMembers;
         connection.reRender("#rankingGrid");
         // initGrid(data);
      });
      connection.on("updateLeaderboard", (giftData, previousTalent) => {
         console.log("updateLeaderboard", giftData);
         console.log("previousTalent", previousTalent);

         const { receiversDetails, round: roundData } = giftData;
         console.log('roundData', roundData);
         console.log('round', round);
         if (round && roundData !== round) return;
         //check if which receiveDiamond in receiversDetails is > 0
         receiversDetails.slice(1).forEach(item => {
            const player = data.find(p => p.name === item.nickname);
            console.log("player", player, player ? player.score : 0);
            if (previousTalent) {
               const previousPlayer = data.find(p => p.name === previousTalent.nickname);
               console.log("previousPlayer", previousPlayer, previousPlayer ? previousPlayer.score : 0);
               if (previousPlayer) previousPlayer.score -= item.receiveDiamond;
            }
            if (player) {
               player.score += item.receiveDiamond;
            } else {
               data.push({
                  name: item.nickname,
                  score: item.receiveDiamond
               });
            }
         });
         renderGrid();
      });
   </script>

</body>

</html>