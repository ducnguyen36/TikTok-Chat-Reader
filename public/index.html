<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HELIOS TALENT</title>

    <meta name="description"
        content="A chat reader for TikTok LIVE utilizing TikTok-Live-Connector and Socket.IO to forward the data to the client. This demo project uses the unofficial TikTok API to retrieve chat comments, gifts and other events from TikTok LIVE.">
    <meta name="keywords"
        content="TikTok,Live,Livestream,Chat,Reader,Scraper,Tracker,tiktok.com,broadcast,api,library,node,node.js,javascript">

    <link rel="stylesheet" href="style.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.min.js" crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/obs-websocket-js"></script>


    <script src="connection.js"></script>
    <script src="app.js"></script>

    <script>
        window.settings = Object.fromEntries(new URLSearchParams(location.search));
        let novixScore = 0;
        let rednovaScore = 0;
        let kayzenScore = 0;
        let tienyeuhoituScore = 0;
        // window.settings = {username: 'kxg.acespace'}
        function manualUpdateScore(input) {
            console.log('onchange input', input)
            let score = parseInt(input.value);
            // if(score === 'NaN'){
            if (isNaN(score)) {
                console.log('not a number', input.value);
                input.value = talents.find(talent => talent.nickname === input.previousElementSibling.previousElementSibling.innerText).receiveDiamond || 0;
                return;
            }
            //update talent score and UI
            let talent = talents.find(t => t.nickname === input.previousElementSibling.previousElementSibling.innerText);
            talent.receiveDiamond = score;
            input.previousElementSibling.innerText = talent.score + talent.receiveDiamond;

            //update RoomStats
            updateRoomStats();


            connection.updateLogFile({
                msgId: 'manual',
                timestamp: Number(Date.now()),
                round: 0
            }, talents);
        }

        function updateLog(button) {
            if (button.classList.contains('active')) return;
            const dataInfo = button.getAttribute('data-info');
            const decodedData = decodeURIComponent(dataInfo); // Decode safely
            console.log('decodedData', decodedData);
            const data = JSON.parse(decodedData); // Parse into JSON
            console.log('dataLog', data); // Now data is accessible safely
            //match the button text nickname to the talents to find the talent
            let talent = talents.find(t => t.nickname === button.innerText);
            let previousTalent = null;
            let score = parseInt(button.parentElement.previousElementSibling.previousElementSibling.childNodes[5].innerText);
            //update UI gift
            //update text describe
            button.parentElement.previousElementSibling.previousElementSibling.childNodes[7].innerHTML = `<b><a class="usernamelink" href="https://www.tiktok.com/@${talent.uniqueId}" target="_blank">
                      <img class="miniprofilepicture" src="${talent.profilePicture.urls[0]}">
                      ${talent.nickname}
                    </a></b>`
            //update active button
            //remove active class from all buttons
            button.parentElement.querySelectorAll('button').forEach(btn => {
                if (btn.classList.contains('active')) {
                    btn.classList.remove('active');
                    previousTalent = talents.find(t => t.nickname === btn.innerText);
                    //update score previous talent
                    previousTalent.score -= parseInt(score);
                    //update UI score previous talent
                    $('#groupmembers .memberContainer[data-userid="' + previousTalent.userId + '"] .memberScore')
                        .text(previousTalent.score + previousTalent.receiveDiamond);
                }
            });
            //add active class to the clicked button
            button.classList.add('active');
            //update score
            talent.score += parseInt(score);
            //update UI score
            $('#groupmembers .memberContainer[data-userid="' + talent.userId + '"] .memberScore')
                .text(talent.score + talent.receiveDiamond);

            let receiversDetails = talents.map(t => {
                const clonedTalent = structuredClone(t); // Deep copy
                delete clonedTalent.score;
                clonedTalent.receiveDiamond = (talent.userId === t.userId) ? score : 0;
                return clonedTalent;
            });
            console.log('receiversDetails', receiversDetails);
            connection.updateLogFile(data, receiversDetails, previousTalent);

        }
        
        connection.on('reRender', data => {
            console.log('reRender data index', data);
            render(data);
        });
            
        function render(data) {
            console.log('reRender', data);
            diamondsCount = 0;
            talents = JSON.parse(JSON.stringify(data[0].receiversDetails));
            talents = talents.map(t => {
                t.score = 0;
                t.receiveDiamond = data[0].receiversDetails.find(talent => talent.userId === t.userId).receiveDiamond;
                return t;
            });
            // Clear the group members container
            var $groupMembers = $("#groupmembers");
            $groupMembers.empty(); // Clear any existing content

            // Iterate over each live member and build the HTML structure
            $.each(talents, function (index, member) {
                // Create container div
                var $memberContainer = $('<div class="memberContainer"></div>').attr('data-userid', member.userId);

                // Create the member avatar element (using the first URL)
                var imgUrl = member.profilePicture.urls[0];
                var $memberAvatar = $('<div class="memberAvatar"></div>').append(
                    $('<img>').attr("src", imgUrl).attr("alt", member.nickname)
                );
                $memberAvatar.click((e) => {
                    $('#idVoting').val(e.target.alt)
                });
                // Create the member info element
                var $memberInfo = $('<div class="memberInfo"></div>');
                var $nickname = $('<div class="memberNickname"></div>').text(member.nickname);
                // var $userId = $('<div class="memberId"></div>').text(member.userId);
                var $score = $('<div class="memberScore"></div>').text(member.score + member.receiveDiamond);
                var $input = $('<input class="manualScore" type="text" onchange="manualUpdateScore(this)" class="memberInput" placeholder="Enter score">');
                $input.val(member.receiveDiamond);
                $memberInfo.append($nickname, $score, $input);

                // Append the avatar and info to the container
                $memberContainer.append($memberAvatar, $memberInfo);

                // Append the member container to the groupmembers container
                $groupMembers.append($memberContainer);

            });
            if (data && data.length > 0) {
                let container = $('.giftcontainer');
                container.empty();

                data.slice(1).forEach(row => {
                    //check if which receiversDetails has receiveDiamond > 0 row.receiverUserDetails init
                    const receiverUserDetails = row.receiversDetails.find(t => t.receiveDiamond > 0);
                    if (receiverUserDetails) {
                        console.log('receiverUserDetails',receiverUserDetails, receiverUserDetails.profilePicture);
                        receiverUserDetails.profilePictureUrl = receiverUserDetails.profilePicture.urls[0];
                        data.receiverUserDetails = receiverUserDetails;
                        //also update receiverUserInGroupLive
                    }

                    let html = `
                        <div data-streakid 
                            style="background-color: ${row.diamondCount >= 199 && row.diamondCount <= 450 ? 'rgba(173, 216, 230, 0.4)' : // Light pastel blue
                            row.diamondCount >= 451 && row.diamondCount <= 1400 ? 'rgba(135, 206, 250, 0.4)' : // Sky blue pastel
                                row.diamondCount >= 1401 && row.diamondCount <= 3500 ? 'rgba(147, 112, 219, 0.4)' : // Light lavender pastel
                                    row.diamondCount >= 3501 && row.diamondCount <= 10000 ? 'rgba(186, 85, 211, 0.4)' : // Orchid pastel
                                        row.diamondCount >= 10001 && row.diamondCount <= 20000 ? 'rgba(218, 112, 214, 0.4)' : // Pale violet pastel
                                            row.diamondCount > 20000 ? 'rgba(221, 160, 221, 0.4)' : // Medium pastel purple
                                                'transparent'
                        }; padding: 3px; margin-bottom: 1px; border-radius: 5px;"
                        >
                            <span>
                                <b>${generateUsernameLink(row)}</b>
                                <span>
                                    sent ${row.giftName}
                                    <img class="gifticon" src="${row.giftPictureUrl}">
                                    <b>x${row.repeatCount}</b>
                                    (<b>${(row.diamondCount * row.repeatCount)} ðŸª™</b> - ${row.giftId}) to
                                    <b>${row.receiverUserDetails ? `
                                        ${generateUsernameLink(row.receiverUserDetails)}
                                    ` : `
                                        <a class="usernamelink" href="https://www.tiktok.com/@${talents[0].uniqueId}" target="_blank">
                                        <img class="miniprofilepicture" src="${talents[0].profilePicture.urls[0]}">
                                        ${talents[0].nickname}(${talents[0].uniqueId})
                                        </a>
                                    `}</b>
                                </span>
                                <br>
                                <span>
                                    ${[...talents].map(talent => `
                                        <button
                                        ${(row.receiversDetails.find(t => t.userId === talent.userId).receiveDiamond > 0) ? 'class="active"' : ''}
                                        data-info='${encodeURIComponent(JSON.stringify(row)).replace(/'/g, "%27")}'
                                        onclick=updateLog(this)
                                        >
                                        ${talent.nickname}
                                        </button>  
                                    `).join('')}
                                </span>
                            </span>
                        </div>
                    `;

                    container.prepend(html);
                    //added score to the talent
                    diamondsCount += row.diamondsTotal;
                    let score = parseInt(row.diamondCount * row.repeatCount);
                    let talent = talents.find(talent => talent.userId === row.receiversDetails.find(t => t.receiveDiamond > 0)?.userId);
                    console.log('row', row, score, talent);
                    if (talent) {
                        //check if personalscore checkbox is checked

                        //get the score of the talent based on round
                        console.log('talent', talent, row.round, round, row.round === round);
                        if (!round || row.round === round || $('input[name="personalScore"]').is(':checked')) talent.score += score;
                        $('#groupmembers .memberContainer[data-userid="' + talent.userId + '"] .memberScore')
                            .text(talent.score + talent.receiveDiamond);
                    }
                });
                console.log('talents', talents);
                //update RoomStats
                updateRoomStats();
                $('#stateText').text('Re-rendered');
            } else {
                $('#stateText').text('No data to re-render');
            }
        }
       
        function reRender() {
            const uniqueId = $('#uniqueIdInput').val();
            connection.reRender(uniqueId);
            $('#stateText').text('Re-rendering...');
        }
        $('document').ready(function () {
            $('[name="round"]').on('click', function () {
                round = this.value;
                if (this.value === '0') round = 0;
                console.log('Round selected:', round);
                connection.setRound(round);
                connection.reRender(talents[0].nickname ==='group' ? 'group' : $('#uniqueIdInput').val()); //TODO: bug when user change uniqueIdInput and click reRender

            });
        });
    </script>
</head>

<body>
    <div class="head">
        <h1>HELIOS TALENT</h1>
    </div>

    <div class="inputFields">
        <pre id="stateText"></pre>
        <label>Username: </label>
        <input type="text" id="uniqueIdInput" placeholder="Enter username">
        <input type="button" id="connectButton" value="connect">
        <input type="button" id="uploadButton" value="upload" onclick="connection.uploadLogFile()">
        <input type="button" id="reRenderButton" value="render" onclick="reRender()">
        <input type="button" id="disconnectButton" value="disconnect" onclick="connection.disconnect()">
    </div>
    <div class="inputFields">
        <label>Nickname: </label>
        <input type="text" id="idVoting" placeholder="Click on the avatar">
        <input type="button" id="votingButton" value="voting"
            onclick="connection.voting(document.getElementById('idVoting').value, document.querySelector('input[name=\'duration\']:checked').value)">
        <input type="button" id="stopVotingButton" value="stop votin" onclick="connection.voting('',0,0)">
        <input type="button" id="countdownButton" value="countdown"
            onclick="connection.countdown(document.querySelector('input[name=\'duration\']:checked').value)">
    </div>
    <div class="inputFields">
        <input type="radio" name="duration" value="1" checked>
        <label for="">1 min</label>
        <input type="radio" name="duration" value="2">
        <label for="">2 min</label>
        <input type="radio" name="duration" value="3">
        <label for="">3 min</label>
        <input type="radio" name="duration" value="5">
        <label for="">5 min</label>
        <input type="radio" name="duration" value="7">
        <label for="">7 min</label>
        <input type="radio" name="duration" value="10">
        <label for="">10 min</label>
    </div>
    <div class="inputFields">
        <input type="radio" name="round" value="0" checked>
        <label for="">none</label>
        <input type="radio" name="round" value="group">
        <label for="">group</label>
        <input type="radio" name="round" value="round1">
        <label for="">round 1</label>
        <input type="radio" name="round" value="round2">
        <label for="">round 2</label>
        <input type="radio" name="round" value="roundPK">
        <label for="">round PK</label>
        <input type="radio" name="round" value="round3">
        <label for="">round 3</label>
        <input type="checkbox" name="personalScore">
        <label for="">personal score</label>
        <input type="checkbox" name="acceptVote" checked onclick="connection.toggleAcceptVote(this.checked)">
        <label for="">Accept Vote</label>
    </div>
    <div class="inputFields">
        <input type="radio" name="groupVote" value="nogroup" checked onclick="$('#idVoting').val('')">
        <label for="">No group</label>
        <input type="radio" name="groupVote" value="novix" onclick="$('#idVoting').val('Novix')">
        <label for="">Novix</label>
        <input type="radio" name="groupVote" value="rednova" onclick="$('#idVoting').val('Rednova')">
        <label for="">Rednova</label>
        <input type="radio" name="groupVote" value="kayzen" onclick="$('#idVoting').val('Kayzen')">
        <label for="">Kayzen</label>
        <input type="radio" name="groupVote" value="tienyeuhoitu" onclick="$('#idVoting').val('TiÃªn YÃªu Há»™i Tá»¥')">
        <label for="">TiÃªn YÃªu Há»™i Tá»¥</label>

    </div>
    <!-- <div>
        <input type="text" id="tienkhiInput" placeholder="Enter tien khi score" value="1">
        <input type="button" id="tienkhiButton" value="tienkhi" onclick="connection.testing(document.getElementById('tienkhiInput').value)">
    </div> -->
    <div id="groupmembers"></div>
    <div id="pkCompetitor"></div>
    <div id="roomStats"></div>
    <div class="giftcontainer">
        <!-- <h3 class="containerheader">Gifts</h3> -->
    </div>
    <hr>
    <div class="chatcontainer">
        <!-- <h3 class="containerheader">Chats</h3> -->
    </div>


</body>

</html>